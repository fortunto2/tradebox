{% extends "sqladmin/layout.html" %}

{% block content %}

<div class="col-12">
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">
        {% for pk in model_view.pk_columns -%}
        {{ pk.name }}
        {%- if not loop.last %};{% endif -%}
        {% endfor %}: {{ get_object_identifier(model) }}</h3>
    </div>
    <div class="card-body border-bottom py-3">
      <div class="table-responsive">
        <table class="table card-table table-vcenter text-nowrap table-hover table-bordered">
          <thead>
            <tr>
              <th class="w-1">Column</th>
              <th class="w-1">Value</th>
            </tr>
          </thead>
          <tbody>
            {% for name in model_view._details_prop_names %}
            {% set label = model_view._column_labels.get(name, name) %}
            <tr>
              <td>{{ label }}</td>
              {% set value, formatted_value = model_view.get_detail_value(model, name) %}
              {% if name in model_view._relation_names %}
              {% if is_list( value ) %}
              <td>
                {% for elem, formatted_elem in zip(value, formatted_value) %}
                <a href="{{ model_view._build_url_for('admin:details', request, elem) }}">({{ formatted_elem }})</a>
                {% endfor %}
              </td>
              {% else %}
              <td><a href="{{ model_view._url_for_details_with_prop(request, model, name) }}">{{ formatted_value }}</a>
              </td>
              {% endif %}
              {% else %}
              <td>{{ formatted_value }}</td>
              {% endif %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Custom Section for Orders List -->
      <h3 class="mt-4">Related Orders</h3>
      <div class="table-responsive">
        <table class="table card-table table-vcenter text-nowrap table-hover table-bordered">
          <thead>
            <tr>
              <th>ID</th>
              <th>Binance ID</th>
              <th>Symbol</th>
              <th>Side</th>
              <th>Price</th>
              <th>Status</th>
              <th>Created At</th>
            </tr>
          </thead>
          <tbody>
            {% for order in model.orders %}
            <tr>
              <td><a href="{{ model_view._build_url_for('admin:details', request, order) }}">{{ order.id }}</a></td>
              <td>{{ order.binance_id }}</td>
              <td>{{ order.symbol }}</td>
              <td>{{ order.side }}</td>
              <td>{{ order.price }}</td>
              <td>{{ order.status }}</td>
              <td>{{ order.created_at }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>


      <!-- Chart Section -->
      <h3 class="mt-4">Orders Chart</h3>
      <canvas id="ordersChart" width="400" height="200"></canvas>

      <!-- End of Custom Section -->

      <div class="card-footer container">
        <div class="row">
          <div class="col-md-1">
            <a href="{{ url_for('admin:list', identity=model_view.identity) }}" class="btn">
              Go Back
            </a>
          </div>
          {% if model_view.can_delete %}
          <div class="col-md-1">
            <a href="#" data-name="{{ model_view.name }}" data-pk="{{ get_object_identifier(model) }}"
              data-url="{{ model_view._url_for_delete(request, model) }}" data-bs-toggle="modal"
              data-bs-target="#modal-delete" class="btn btn-danger">
              Delete
            </a>
          </div>
          {% endif %}
          {% if model_view.can_edit %}
          <div class="col-md-1">
            <a href="{{ model_view._build_url_for('admin:edit', request, model) }}" class="btn btn-primary">
              Edit
            </a>
          </div>
          {% endif %}
          {% for custom_action,label in model_view._custom_actions_in_detail.items() %}
          <div class="col-md-1">
            {% if custom_action in model_view._custom_actions_confirmation %}
            <a href="#" class="btn btn-secondary" data-bs-toggle="modal"
              data-bs-target="#modal-confirmation-{{ custom_action }}">
              {{ label }}
            </a>
            {% else %}
            <a href="{{ model_view._url_for_action(request, custom_action) }}?pks={{ get_object_identifier(model) }}"
              class="btn btn-secondary">
              {{ label }}
            </a>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

{% if model_view.can_delete %}
{% include 'sqladmin/modals/delete.html' %}
{% endif %}

{% for custom_action in model_view._custom_actions_in_detail %}
{% if custom_action in model_view._custom_actions_confirmation %}
{% with confirmation_message = model_view._custom_actions_confirmation[custom_action], custom_action=custom_action,
url=model_view._url_for_action(request, custom_action) + '?pks=' + (get_object_identifier(model) | string) %}
{% include 'sqladmin/modals/details_action_confirmation.html' %}
{% endwith %}
{% endif %}
{% endfor %}

<!-- Interval Selection -->
<div style="margin-top: 20px;">
  <label for="interval-select">Select Interval:</label>
  <select id="interval-select">
<!--    <option value="1s">1 Seconds</option>-->
    <option value="1m">1 Minute</option>
    <option value="5m">5 Minutes</option>
    <option value="15m">15 Minutes</option>
    <option value="1h">1 Hour</option>
    <option value="1d">1 Day</option>
  </select>
</div>

<!-- Candlestick Chart with Custom Markers -->
<div id="chart-container" style="width: 100%; height: 500px; position: relative; margin-top: 20px;"></div>

<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
<script>
  function getCandlestickData(interval) {
    // Fetch candlestick data based on the selected interval
    var theUrl = "https://fapi.binance.com/fapi/v1/klines?symbol={{ model.symbol }}&interval=" + interval + "&limit=100";
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.open("GET", theUrl, false); // false for synchronous request
    xmlHttp.send(null);
    var response = JSON.parse(xmlHttp.responseText);

    var result = [];
    for (var i = 0; i < response.length; i++) {
      result.push({
        time: response[i][0] / 1000,
        open: parseFloat(response[i][1]),
        high: parseFloat(response[i][2]),
        low: parseFloat(response[i][3]),
        close: parseFloat(response[i][4])
      });
    }
    return result;
  }

  function renderChart(interval) {
    const chartContainer = document.getElementById('chart-container');
    chartContainer.innerHTML = ''; // Clear previous chart

 const chart = LightweightCharts.createChart(chartContainer, {
    layout: {
      background: { color: '#161a1e' },
      textColor: '#D9D9D9',
    },
    grid: {
      vertLines: { color: '#2B2B43' },
      horzLines: { color: '#363C4E' },
    },
    timeScale: {
      timeVisible: true,   // Ensure time visibility is enabled
      secondsVisible: true, // Show seconds if zoomed in enough
      tickMarkFormatter: (time, tickMarkType, locale) => {
        const date = new Date(time * 1000);
        return `${date.getHours()}:${date.getMinutes()}:${date.getSeconds()}`;
      }
    },
  });

    const candleStickData = getCandlestickData(interval);
    const candleSeries = chart.addCandlestickSeries();
    candleSeries.setData(candleStickData);

    // Add markers for each order
    const orderMarkers = [
      {% for order in model.orders %}
      {
        time: Math.floor(new Date("{{ order.created_at.isoformat() }}").getTime() / 1000),  // Corrected time conversion
        position: '{{ "aboveBar" if order.side.value == "SELL" else "belowBar" }}',
        color: '{{ "red" if order.side.value == "SELL" else "green" }}',
        shape: '{{ "arrowDown" if order.side.value == "SELL" else "arrowUp" }}',
        text: '{{ order.side.value }} at {{ order.price }}'
      },
      {% endfor %}
    ];

    candleSeries.setMarkers(orderMarkers);
    console.log(orderMarkers)
// Automatically zoom to the area where orders are located
  if (orderMarkers.length > 0) {
    const times = orderMarkers.map(marker => marker.time);
    const minTime = Math.min(...times);
    const maxTime = Math.max(...times);

    chart.timeScale().setVisibleRange({
      from: minTime,
      to: maxTime
    });
  }

  // Resize the chart on window resize
  window.addEventListener("resize", () => {
    chart.resize(window.innerWidth, 500);
  });
}

// Initial render with default interval (1 minute) and automatic zoom
renderChart('1m');

// Update chart on interval selection change
document.getElementById('interval-select').addEventListener('change', function () {
  renderChart(this.value);
});
</script>


{% endblock %}
