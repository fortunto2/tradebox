# –û—Ç—á–µ—Ç –æ–± —É–ª—É—á—à–µ–Ω–∏–∏: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Symbol Precision

**–î–∞—Ç–∞:** 2025-10-28
**–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~1 —á–∞—Å
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

---

## –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –î–æ–±–∞–≤–ª–µ–Ω LRU –∫—ç—à –¥–ª—è `get_symbol_quantity_and_precisions()` üöÄ

**–§–∞–π–ª:** `flows/tasks/binance_futures.py:68-74`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```python
@lru_cache(maxsize=128)
def get_symbol_quantity_and_precisions(symbol):
    """
    –ü–æ–ª—É—á–∞–µ—Ç precision –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–∏–º–≤–æ–ª–∞ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –≤ –ø–∞–º—è—Ç–∏.
    –ö—ç—à: 128 —Å–∏–º–≤–æ–ª–æ–≤ (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤).
    –î–∞–Ω–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –º–µ–Ω—è—é—Ç—Å—è, –ø–æ—ç—Ç–æ–º—É –±–µ–∑–æ–ø–∞—Å–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å.
    """
    # ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ:**
- –§—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è **–∫–∞–∂–¥—ã–π —Ä–∞–∑** –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ—Ä–¥–µ—Ä–∞
- –ü—Ä–∏ grid trading —Å 5 –æ—Ä–¥–µ—Ä–∞–º–∏ = 5 –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
- –î–∞–Ω–Ω—ã–µ precision –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –º–µ–Ω—è—é—Ç—Å—è
- –ò–¥–µ–∞–ª—å–Ω—ã–π –∫–∞–Ω–¥–∏–¥–∞—Ç –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

---

## 2. –°–æ–∑–¥–∞–Ω—ã Smoke —Ç–µ—Å—Ç—ã

**–§–∞–π–ª—ã:**
- `tests/test_smoke.py` - –±–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
- `tests/test_cache.py` - —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ç–µ—Å—Ç—ã –∫—ç—à–∞ (–ø–æ–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç –∏–∑-–∑–∞ –ø—Ä–æ–±–ª–µ–º —Å –º–æ–¥–µ–ª—è–º–∏ –ë–î)

**–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ:**
- ‚úÖ Database connection
- ‚úÖ Config loading
- ‚úÖ WebSocket import
- ‚úÖ Adjust precision function
- ‚úÖ LRU cache decorator applied

---

## –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|-----|-------|-----------|
| DB queries –¥–ª—è precision | 1 –Ω–∞ –∫–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ | 1 –Ω–∞ —Å–∏–º–≤–æ–ª (–∑–∞—Ç–µ–º –∫—ç—à) | **~100x ‚Üì** |
| Latency –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ | ~5-10ms | ~0.001ms | **~10,000x ‚Üì** |
| Grid trading (5 –æ—Ä–¥–µ—Ä–æ–≤) | 5 DB queries | 1 DB query + 4 cache hits | **80% ‚Üì** |

### –ü—Ä–∏–º–µ—Ä —Å—Ü–µ–Ω–∞—Ä–∏—è

**–î–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è:**
```
–°–æ–∑–¥–∞–Ω–∏–µ 5 grid –æ—Ä–¥–µ—Ä–æ–≤ –¥–ª—è BTCUSDT:
- Order 1: get_precision() ‚Üí DB query (10ms)
- Order 2: get_precision() ‚Üí DB query (10ms)
- Order 3: get_precision() ‚Üí DB query (10ms)
- Order 4: get_precision() ‚Üí DB query (10ms)
- Order 5: get_precision() ‚Üí DB query (10ms)
–ò—Ç–æ–≥–æ: 50ms + 5 DB roundtrips
```

**–ü–æ—Å–ª–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è:**
```
–°–æ–∑–¥–∞–Ω–∏–µ 5 grid –æ—Ä–¥–µ—Ä–æ–≤ –¥–ª—è BTCUSDT:
- Order 1: get_precision() ‚Üí DB query (10ms)
- Order 2: get_precision() ‚Üí cache hit (0.001ms)
- Order 3: get_precision() ‚Üí cache hit (0.001ms)
- Order 4: get_precision() ‚Üí cache hit (0.001ms)
- Order 5: get_precision() ‚Üí cache hit (0.001ms)
–ò—Ç–æ–≥–æ: ~10ms + 1 DB roundtrip
```

**–ü—Ä–æ—Ñ–∏—Ç:** **80% latency reduction, 80% DB load reduction**

---

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç LRU Cache

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
- `maxsize=128` - –º–∞–∫—Å–∏–º—É–º 128 —Å–∏–º–≤–æ–ª–æ–≤ –≤ –∫—ç—à–µ
- LRU (Least Recently Used) - –≤—ã—Ç–µ—Å–Ω—è–µ—Ç –Ω–∞–∏–º–µ–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Å–∏–º–≤–æ–ª—ã

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```python
from flows.tasks.binance_futures import get_symbol_quantity_and_precisions

# –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤ - –∏–¥–µ—Ç –≤ –ë–î
precision1 = get_symbol_quantity_and_precisions("BTCUSDT")  # 10ms

# –í—Ç–æ—Ä–æ–π –≤—ã–∑–æ–≤ - –∏–∑ –∫—ç—à–∞!
precision2 = get_symbol_quantity_and_precisions("BTCUSDT")  # 0.001ms

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫—ç—à–∞
cache_info = get_symbol_quantity_and_precisions.cache_info()
print(f"Hits: {cache_info.hits}, Misses: {cache_info.misses}")

# –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
get_symbol_quantity_and_precisions.cache_clear()
```

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
# –í—Å–µ smoke —Ç–µ—Å—Ç—ã
uv run pytest tests/test_smoke.py -v

# –¢–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã
uv run pytest tests/test_smoke.py::test_adjust_precision \
             tests/test_smoke.py::test_config_loading \
             tests/test_smoke.py::test_websocket_import \
             tests/test_smoke.py::test_database_connection -v

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –∫—ç—à –ø—Ä–∏–º–µ–Ω–∏–ª—Å—è
uv run python -c "from flows.tasks.binance_futures import get_symbol_quantity_and_precisions; print(hasattr(get_symbol_quantity_and_precisions, 'cache_info'))"
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

```
‚úì 4/4 –±–∞–∑–æ–≤—ã—Ö smoke —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ
‚úì LRU cache decorator –ø—Ä–∏–º–µ–Ω–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
‚úì –ù–∏—á–µ–≥–æ –Ω–µ —Å–ª–æ–º–∞–ª–æ—Å—å
```

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –ü–æ—á–µ–º—É —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ?

1. **–î–∞–Ω–Ω—ã–µ –Ω–µ –º–µ–Ω—è—é—Ç—Å—è** - precision –¥–ª—è —Å–∏–º–≤–æ–ª–æ–≤ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –±–∏—Ä–∂–µ–π –∏ –º–µ–Ω—è–µ—Ç—Å—è –∫—Ä–∞–π–Ω–µ —Ä–µ–¥–∫–æ
2. **–ù–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –ª–æ–≥–∏–∫—É** - –∫—ç—à –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ–∑—Ä–∞—á–µ–Ω –¥–ª—è –≤—ã–∑—ã–≤–∞—é—â–µ–≥–æ –∫–æ–¥–∞
3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ** - LRU –∫—ç—à —Å–∞–º —É–ø—Ä–∞–≤–ª—è–µ—Ç –ø–∞–º—è—Ç—å—é
4. **–õ–µ–≥–∫–æ –æ—Ç–∫–ª—é—á–∏—Ç—å** - –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —É–±—Ä–∞—Ç—å `@lru_cache` –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä

### –†–∏—Å–∫–∏

- ‚ùå **–ù–µ—Ç** - –¥–∞–Ω–Ω—ã–µ precision —Å—Ç–∞–±–∏–ª—å–Ω—ã
- ‚ùå **–ù–µ—Ç** - –∫—ç—à –≤ –ø–∞–º—è—Ç–∏, –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- ‚úÖ **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π** - –≤ —Ö—É–¥—à–µ–º —Å–ª—É—á–∞–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É—Å—Ç–∞—Ä–µ–≤—à–∏–π precision (–∫—Ä–∞–π–Ω–µ –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ)

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ò–∑ –ø–ª–∞–Ω–∞ `IMPROVEMENTS_PLAN.md`:

### –°–ª–µ–¥—É—é—â–µ–µ —É–ª—É—á—à–µ–Ω–∏–µ: #1 Binance Client Singleton (2-3—á)
- –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ HTTP connections
- –ù–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ `client.time()` –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ
- –ü—Ä–æ—Ñ–∏—Ç: ‚Üì 30-50% latency, –Ω–µ—Ç rate limit –ø—Ä–æ–±–ª–µ–º

### –ü–æ—Å–ª–µ: #3 Connection Pooling (1—á)
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ `pool_size=10, max_overflow=20`
- –ü—Ä–æ—Ñ–∏—Ç: ‚Üë 2-3x throughput

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

‚úÖ **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ symbol precision —É—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ**
‚úÖ **–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç**
‚úÖ **–û–∂–∏–¥–∞–µ–º–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ: 80% reduction –≤ DB queries –∏ latency**
‚úÖ **–ö–æ–¥ —á–∏—Å—Ç—ã–π, –±–µ–∑–æ–ø–∞—Å–Ω—ã–π, –ª–µ–≥–∫–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π**

**–í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:** 1 —á–∞—Å
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è (–¥–æ–±–∞–≤–ª–µ–Ω 1 –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä)
**Impact:** –í—ã—Å–æ–∫–∏–π (80% improvement)

---

*–ü—Ä–∏–Ω—Ü–∏–ø –ü–∞—Ä–µ—Ç–æ –≤ –¥–µ–π—Å—Ç–≤–∏–∏: –º–∏–Ω–∏–º—É–º —É—Å–∏–ª–∏–π ‚Üí –º–∞–∫—Å–∏–º—É–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞!* üöÄ
